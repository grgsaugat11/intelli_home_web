<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>MQTT Relay Scheduler</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <h1>MQTT Relay Controller with Scheduler</h1>
  <div id="status">Connecting to MQTT broker...</div>
  <div class="relay-container" id="relays"></div>

  <script>
    const broker = 'ws://broker.emqx.io:8083/mqtt';
    const topic = 'relay/control';
    const client = mqtt.connect(broker);

    const relays = ['r1', 'r2', 'r3', 'r4'];
    const relayState = { r1: 'OFF', r2: 'OFF', r3: 'OFF', r4: 'OFF' };
    const schedulerConfig = {};
    const lastTriggerTime = {};

    client.on('connect', () => {
      document.getElementById('status').innerText = 'âœ… Connected to MQTT broker';
    });

    function renderRelays() {
      const container = document.getElementById('relays');
      relays.forEach(relay => {
        schedulerConfig[relay] = { onTime: null, offTime: null };
        lastTriggerTime[relay] = null;

        container.innerHTML += `
          <div class="relay">
            <h3>${relay.toUpperCase()}</h3>
            <label class="switch">
              <input type="checkbox" id="toggle-${relay}" onchange="toggleRelay('${relay}', this)">
              <span class="slider"></span>
            </label>
            <div class="status-text" id="status-${relay}">Status: OFF</div>

            <label><input type="checkbox" onchange="toggleScheduler('${relay}')"> Schedule?</label>

            <div id="scheduler-panel-${relay}" class="scheduler-panel">
              <p><strong>Schedule</strong></p>
              <label>Turn ON at: <input type="time" id="on-time-${relay}"></label><br>
              <label>Turn OFF at: <input type="time" id="off-time-${relay}"></label><br>
              <div class="error" id="error-${relay}"></div>
              <button onclick="setSchedule('${relay}')">Set Schedule</button>
              <button onclick="clearSchedule('${relay}')">Clear Schedule</button>
            </div>
          </div>
        `;
      });
    }

    function toggleRelay(relay, el) {
      if (!client.connected) {
        alert("MQTT not connected");
        el.checked = !el.checked;
        return;
      }

      const newState = el.checked ? 'ON' : 'OFF';

      if (relayState[relay] !== newState) {
        relayState[relay] = newState;
        client.publish(topic, JSON.stringify(relayState));
        document.getElementById(`status-${relay}`).innerText = `Status: ${newState}`;
      }
    }

    function toggleScheduler(relay) {
      const panel = document.getElementById(`scheduler-panel-${relay}`);
      panel.classList.toggle('open');
    }

    function setSchedule(relay) {
      const onTime = document.getElementById(`on-time-${relay}`).value;
      const offTime = document.getElementById(`off-time-${relay}`).value;
      const errorEl = document.getElementById(`error-${relay}`);
      errorEl.innerText = '';

      if (!onTime && !offTime) {
        errorEl.innerText = 'âŒ Please enter ON and/or OFF time.';
        return;
      }

      schedulerConfig[relay] = {
        onTime: onTime || null,
        offTime: offTime || null
      };

      alert(`${relay.toUpperCase()} schedule set.`);
    }

    function clearSchedule(relay) {
      schedulerConfig[relay] = { onTime: null, offTime: null };
      document.getElementById(`on-time-${relay}`).value = '';
      document.getElementById(`off-time-${relay}`).value = '';
      document.getElementById(`error-${relay}`).innerText = '';
      alert(`${relay.toUpperCase()} schedule cleared.`);
    }

    function getTimeStr(date = new Date()) {
      return date.toTimeString().slice(0, 5);
    }

    function checkScheduler() {
      const now = getTimeStr();

      relays.forEach(relay => {
        const config = schedulerConfig[relay];
        const toggle = document.getElementById(`toggle-${relay}`);
        if (!config) return;

        if (config.onTime === now && lastTriggerTime[relay] !== `on-${now}`) {
          if (relayState[relay] === 'OFF') {
            toggle.checked = true;
            toggleRelay(relay, toggle);
          }
          lastTriggerTime[relay] = `on-${now}`;
        }

        if (config.offTime === now && lastTriggerTime[relay] !== `off-${now}`) {
          if (relayState[relay] === 'ON') {
            toggle.checked = false;
            toggleRelay(relay, toggle);
          }
          lastTriggerTime[relay] = `off-${now}`;
        }
      });
    }

    renderRelays();
    setInterval(checkScheduler, 1000);

    // MQTT diagnostics
    client.on('error', (err) => {
      document.getElementById('status').innerText = `âŒ Error: ${err.message}`;
    });
    client.on('close', () => {
      document.getElementById('status').innerText = 'âŒ Disconnected from MQTT broker';
    });
    client.on('reconnect', () => {
      document.getElementById('status').innerText = 'ðŸ”„ Reconnecting to MQTT broker...';
    });
    client.on('offline', () => {
      document.getElementById('status').innerText = 'âŒ Offline from MQTT broker';
    });
    client.on('message', (topic, message) => {
      console.log(`Received message on ${topic}: ${message.toString()}`);
    });
  </script>
</body>
</html>
